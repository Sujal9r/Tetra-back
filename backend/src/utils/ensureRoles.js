import Role from "../models/Role.js";
import { PERMISSIONS } from "./roles.js";

const USER_ROLE_KEY = "user";
const USER_ROLE_NAME = "User";
const USER_BASE_PERMISSIONS = [
  PERMISSIONS.VIEW_DASHBOARD,
  PERMISSIONS.VIEW_MY_WORKSPACE,
  PERMISSIONS.VIEW_USER_TASKS,
  PERMISSIONS.ATTENDANCE_CLOCK,
  PERMISSIONS.VIEW_USER_FINANCE,
  PERMISSIONS.LEAVE_APPLY,
  PERMISSIONS.LEAVE_VIEW_MY,
  PERMISSIONS.LEAVE_CANCEL_MY,
  PERMISSIONS.LEAVE_VIEW_BALANCE,
  PERMISSIONS.LEAVE_CALENDAR_VIEW,
  PERMISSIONS.LEAVE_POLICY_VIEW,
  PERMISSIONS.ATTENDANCE_PANEL_VIEW,
  PERMISSIONS.VIEW_SETTINGS,
];

export const ensureDefaultRoles = async () => {
  const existing = await Role.findOne({ key: USER_ROLE_KEY });

  if (!existing) {
    await Role.create({
      name: USER_ROLE_NAME,
      key: USER_ROLE_KEY,
      slug: USER_ROLE_KEY,
      permissions: USER_BASE_PERMISSIONS,
      isSystem: false,
    });
    console.log("Created default user role");
    return;
  }

  const current = Array.isArray(existing.permissions) ? existing.permissions : [];
  const merged = Array.from(new Set([...current, ...USER_BASE_PERMISSIONS]));
  const shouldUpdate = merged.length !== current.length;

  if (shouldUpdate) {
    existing.permissions = merged;
    if (!existing.slug) {
      existing.slug = existing.key;
    }
    existing.isSystem = false;
    await existing.save();
    console.log("Updated default user role permissions");
  }
};
